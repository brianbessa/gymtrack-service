{% extends "base.html" %}
{% load static %}

{% block title %}Acompanhar Progresso - GymTrack{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/acompanhar-processo-cargas.css' %}">
{% endblock %}

{% block content %}
<main class="main-content">
  <section class="progresso-section">
    <h1>Seu Progresso</h1>

    <div class="filter-wrapper">
      <div class="tabs-filter-wrapper">
        <div class="tabs-container">
          <a href="{% url 'acompanhar-processo-cargas' %}" class="tab {% if active_tab == 'cargas' %}active{% endif %}">Cargas</a>
          <a href="{% url 'acompanhar-processo-medicoes' %}" class="tab {% if active_tab == 'medicoes' %}active{% endif %}">Medições</a>
        </div>
      </div>

      <div class="filters">
        <!-- Select do exercício -->
        <select id="exercicioSelect">
          {% for exercicio in exercicios %}
            <option value="{{ exercicio.id }}">{{ exercicio.nome }}</option>
          {% endfor %}
        </select>

        <!-- Simulação de filtro por período -->
        <select>
          <option>Últimos 30 dias</option>
          <option>Últimos 7 dias</option>
          <option>Últimos 90 dias</option>
        </select>
      </div>
    </div>

    <!-- Cards resumo -->
    <div class="cards-resumo" id="cardsResumo">
      <div class="card">
        <h2 id="cardMaxCarga">--</h2>
        <p>Carga máxima</p>
      </div>
      <div class="card">
        <h2 id="cardTotalReps">--</h2>
        <p>Total de repetições</p>
      </div>
      <div class="card">
        <h2 id="cardTotalSeries">--</h2>
        <p>Total de séries</p>
      </div>
    </div>

    <!-- Gráfico -->
    <div class="grafico-wrapper">
      <h3>CARGA X TEMPO</h3>
      <canvas id="graficoCargas" height="100"></canvas>
    </div>

    <div class="grafico-wrapper">
      <h3>SÉRIES X REPETIÇÕES</h3>
      <canvas id="graficoSeriesReps" height="100"></canvas>
    </div>
  </section>

  <div class="overview" id="overviewTexto">
    <p>Carregando visão geral...</p>
  </div>
</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chartInstance = null;
  let chartSeriesReps = null;

  function renderChart(labels, data) {
    const ctx = document.getElementById('graficoCargas').getContext('2d');
    if (chartInstance) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Carga (kg)',
          data: data,
          borderColor: 'blue',
          backgroundColor: 'rgba(0, 123, 255, 0.2)',
          tension: 0.3,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Carga (kg)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Data e Hora'
            }
          }
        },
        plugins: {
          legend: {
            display: true
          },
          title: {
            display: false
          }
        }
      }
    });
  }

  function buscarDadosDoGrafico(exercicioId) {
    fetch(`/grafico/cargas/${exercicioId}/`)
      .then(response => response.json())
      .then(data => {
        renderChart(data.labels, data.data);
        document.getElementById("cardMaxCarga").innerText = data.max_carga + " kg";
        document.getElementById("cardTotalReps").innerText = data.total_reps;
        document.getElementById("cardTotalSeries").innerText = data.total_series;

        const overview = `
          No exercício selecionado, você atingiu sua maior carga de <strong>${data.max_carga}kg</strong>${data.data_max_carga ? ` em ${data.data_max_carga}` : ""}.
          <br>
          Você realizou <strong>${data.total_reps}</strong> repetições em <strong>${data.total_series}</strong> séries.
          <br>
          Sua média de repetições por série é <strong>${data.media_reps_por_serie}</strong>.
          <br>
          A evolução da carga foi de <strong>${(data.min_carga > 0 ? Math.round(((data.max_carga - data.min_carga) / data.min_carga) * 100) : 0)}%</strong> desde a menor carga registrada.
        `;
        document.getElementById("overviewTexto").innerHTML = overview;
      });

    fetch(`/grafico/series-repeticoes/${exercicioId}/`)
      .then(response => response.json())
      .then(data => {
        console.log("Dados recebidos para gráfico séries/reps:", data);  // Adicione isto
        renderBarChart(data.labels, data.data);
      });

  }

  document.addEventListener("DOMContentLoaded", function () {
    const exercicioSelect = document.getElementById("exercicioSelect");
    const exercicioId = exercicioSelect.value;
    buscarDadosDoGrafico(exercicioId);

    exercicioSelect.addEventListener("change", function () {
      buscarDadosDoGrafico(this.value);
    });
  });

  function renderBarChart(labels, data) {
    const ctx = document.getElementById('graficoSeriesReps').getContext('2d');
    if (chartSeriesReps) {
      chartSeriesReps.destroy();
    }

    chartSeriesReps = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Total de repetições por dia',
          data: data,
          backgroundColor: 'rgba(40, 167, 69, 0.6)',
          borderColor: 'rgba(40, 167, 69, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Repetições'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Data'
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}
